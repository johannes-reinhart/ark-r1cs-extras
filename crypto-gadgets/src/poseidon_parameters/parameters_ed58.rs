use crate::poseidon_parameters::{convert_str_vec_to_fields, PoseidonConfigError};
use ark_crypto_primitives::sponge::poseidon::PoseidonConfig;
use ark_ed58::Fr;
use ark_ff::PrimeField;
#[cfg(not(feature = "std"))]
use ark_std::vec;

pub fn poseidon_parameters<F: PrimeField>() -> Result<PoseidonConfig<F>, PoseidonConfigError> {
    let rate = 4;
    let capacity = 1;
    let full_rounds = 8;
    let partial_rounds = 10;
    let alpha = 5;
    let t = rate + capacity;
    let ark = vec![
        "47837209810539788",
        "197033914614858958",
        "54445233091751458",
        "26677146226549117",
        "124422462894907153",
        "177560671928097804",
        "95593180741285946",
        "107114171627236281",
        "29227926414070061",
        "82239081658557054",
        "125070741655950190",
        "2957818567144874",
        "149984896914918765",
        "202800007695984088",
        "110003737805085293",
        "96889033793207509",
        "102000141647680499",
        "115246561078759749",
        "107716982660001215",
        "45263188569396342",
        "80264246814916052",
        "46611487770254061",
        "2506344851905119",
        "126830021331150798",
        "180791067168224518",
        "79616616399894213",
        "60791084805417761",
        "106302278535791826",
        "50868373794081767",
        "103574814055709107",
        "173673558066253772",
        "90985837579196782",
        "179536073938301653",
        "7265784288258607",
        "206155297031510521",
        "66261881185667669",
        "113789875340184713",
        "151674349263382096",
        "163537207596750434",
        "52561776252710724",
        "179518390157760824",
        "57092621474733541",
        "34266579829658874",
        "7340489176487104",
        "63140519022559318",
        "137570045574603596",
        "33014569422201524",
        "140031943566672406",
        "136689440836825432",
        "42798036475143546",
        "48764734285234329",
        "33528334139883184",
        "178159601049261936",
        "62577945562570067",
        "53496502439626525",
        "30516594485443802",
        "136078854903422428",
        "150131056497755713",
        "149808915765249427",
        "35814821481651681",
        "120404269396270321",
        "53982582710811028",
        "181322182922817598",
        "56975618027112523",
        "54196228134401623",
        "1396180117626664",
        "105533427793693142",
        "13718165925406987",
        "147298668979793045",
        "86827488945863076",
        "140983423386090461",
        "198702764925889449",
        "196209750300513683",
        "152068079854839459",
        "189336375332275105",
        "194979728587935444",
        "46171017896902357",
        "190091102054909452",
        "192388432760457108",
        "210884658069903850",
        "203193666500208163",
        "36925210107122991",
        "56408889103742036",
        "142117604816971835",
        "162421843974171202",
        "140928432242023068",
        "205697060695396049",
        "60515666795661517",
        "172844783353748989",
        "90616865530809763",
    ];
    let mds = vec![
        "147830950619734243",
        "209098289879142223",
        "41929135702260957",
        "27448018408030203",
        "190853163242418358",
        "144173280488030624",
        "65880758518010405",
        "64383355220701091",
        "203870586458583900",
        "25220020562462629",
        "9953962485190088",
        "103410661330916311",
        "87072641264095277",
        "118684409296322113",
        "8566801760841712",
        "69230964743296762",
        "13894767351283910",
        "25255372162367659",
        "26047767165603364",
        "22217330582922355",
        "24753219962818527",
        "180286855998245750",
        "75219618592016978",
        "57258617790262434",
        "78496905310371859",
    ];

    assert_eq!(ark.len(), (full_rounds + partial_rounds) * t);
    assert_eq!(mds.len(), t * t);

    let ark = convert_str_vec_to_fields::<F>(t, &ark)
        .map_err(|_| PoseidonConfigError::ConversionError)?;
    let mds = convert_str_vec_to_fields::<F>(t, &mds)
        .map_err(|_| PoseidonConfigError::ConversionError)?;

    Ok(PoseidonConfig {
        full_rounds,
        partial_rounds,
        alpha,
        ark,
        mds,
        rate,
        capacity,
    })
}

pub fn poseidon_parameters_ed58() -> PoseidonConfig<Fr> {
    poseidon_parameters::<Fr>().unwrap_or_else(|_| panic!("could not convert parameters"))
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::poseidon_parameters::tests::test_poseidon_against_vectors;
    use ark_ed58::Fr;
    use std::str::FromStr;

    #[test]
    fn test_poseidon() {
        let params = poseidon_parameters_ed58();

        let input0 = vec![Fr::from(0)];
        let digest0 = Fr::from_str("5809011834168962").unwrap();

        let input1 = vec![Fr::from(1), Fr::from(2), Fr::from(42)];
        let digest1 = Fr::from_str("62392253330612586").unwrap();

        let input2 = vec![
            Fr::from(2347272),
            Fr::from(3512325),
            Fr::from(950157783),
            Fr::from(35),
            Fr::from(26357),
            Fr::from(354738949),
            Fr::from(30086),
            Fr::from(246849),
            Fr::from(56943),
        ];
        let digest2 = Fr::from_str("28802605602041323").unwrap();

        let input3: Vec<_> = (0..100).into_iter().map(|i| Fr::from(i)).collect();
        let digest3 = Fr::from_str("25961001131555776").unwrap();

        test_poseidon_against_vectors(
            &params,
            &vec![
                input0.as_slice(),
                input1.as_slice(),
                input2.as_slice(),
                input3.as_slice(),
            ],
            &vec![digest0, digest1, digest2, digest3],
        )
    }
}
