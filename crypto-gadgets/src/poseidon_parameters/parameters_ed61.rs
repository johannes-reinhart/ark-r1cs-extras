use crate::poseidon_parameters::{convert_str_vec_to_fields, PoseidonConfigError};
use ark_crypto_primitives::sponge::poseidon::PoseidonConfig;
use ark_ed61::Fr;
use ark_ff::PrimeField;
#[cfg(not(feature = "std"))]
use ark_std::vec;

pub fn poseidon_parameters<F: PrimeField>() -> Result<PoseidonConfig<F>, PoseidonConfigError> {
    let rate = 4;
    let capacity = 1;
    let full_rounds = 8;
    let partial_rounds = 10;
    let alpha = 5;
    let t = rate + capacity;
    let ark = vec![
        "653361878762994258",
        "677536946805474649",
        "699425330641366824",
        "112832663983342378",
        "899409395765957440",
        "90141335156503571",
        "981079405043904309",
        "326206684344624622",
        "213641548820240892",
        "30394795445936133",
        "617589349922213242",
        "848002320261503473",
        "405781195540368741",
        "620180277668856701",
        "1214544878818176346",
        "277813375045847799",
        "864081260695186028",
        "1159987327380722057",
        "310277132076076162",
        "668036906834761214",
        "1173855810867275825",
        "687454274869453523",
        "882982750884380577",
        "522401043489685896",
        "525095750058718371",
        "906881638081912525",
        "208483446381212544",
        "209612271053976821",
        "1109942139909792084",
        "1161733740079919788",
        "271607256687205359",
        "1000119272188744428",
        "482028976408688078",
        "570056209434552417",
        "692657177999370319",
        "117572113318501210",
        "105960356732935093",
        "1185972591722402520",
        "155282862861294905",
        "848442087630666340",
        "1142807212115855328",
        "790253797873250394",
        "1041223007611412965",
        "101332821661962597",
        "476516620810550668",
        "898824651228456156",
        "821191899500966505",
        "659304468038606905",
        "1007830277032773678",
        "57614138337541776",
        "672802775925389844",
        "905371806260978443",
        "551298367270250378",
        "889755132438216772",
        "1152588232736581715",
        "178264139903607792",
        "1083914119692127851",
        "635043352035648641",
        "728778330203246353",
        "1235180540802144264",
        "114918585888342503",
        "213783870679232197",
        "496159487235402460",
        "662639190960167535",
        "1154419726807817422",
        "13673639864880112",
        "725613931800212253",
        "1143504442987281328",
        "70235410313874165",
        "157019926024055195",
        "521470478285928629",
        "330028753695809630",
        "440813975507312761",
        "1218366716287187679",
        "790108466008576592",
        "996757616694664753",
        "932821192483922222",
        "1009502045073060188",
        "115506994513225669",
        "738064558686326762",
        "178263196242856854",
        "544422842773757787",
        "891143207709907471",
        "526746619498029580",
        "916682634332321210",
        "175144778975209496",
        "657808597384415422",
        "92952729718059281",
        "313312477613760755",
        "602262443069187403",
    ];
    let mds = vec![
        "1120189551789992180",
        "178168491636899243",
        "408745986438291462",
        "692085139161480621",
        "979482546473369953",
        "1214287340474352146",
        "825134766750668432",
        "784736489500808153",
        "558732499562533573",
        "153582835230480265",
        "967305994593552377",
        "50464080865699115",
        "368070029871754251",
        "826180805703406901",
        "398726418448384473",
        "162752982437192494",
        "846376783492889181",
        "636649558693223631",
        "976199420799245516",
        "26194397931788579",
        "814022886691163386",
        "832952273210658936",
        "1158050338792709832",
        "301957853152939235",
        "989863172875818957",
    ];

    assert_eq!(ark.len(), (full_rounds + partial_rounds) * t);
    assert_eq!(mds.len(), t * t);

    let ark = convert_str_vec_to_fields::<F>(t, &ark)
        .map_err(|_| PoseidonConfigError::ConversionError)?;
    let mds = convert_str_vec_to_fields::<F>(t, &mds)
        .map_err(|_| PoseidonConfigError::ConversionError)?;

    Ok(PoseidonConfig {
        full_rounds,
        partial_rounds,
        alpha,
        ark,
        mds,
        rate,
        capacity,
    })
}

pub fn poseidon_parameters_ed61() -> PoseidonConfig<Fr> {
    poseidon_parameters::<Fr>().unwrap_or_else(|_| panic!("could not convert parameters"))
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::poseidon_parameters::tests::test_poseidon_against_vectors;
    use ark_ed61::Fr;
    use std::str::FromStr;

    #[test]
    fn test_poseidon() {
        let params = poseidon_parameters_ed61();

        let input0 = vec![Fr::from(0)];
        let digest0 = Fr::from_str("50118020670818737").unwrap();

        let input1 = vec![Fr::from(1), Fr::from(2), Fr::from(42)];
        let digest1 = Fr::from_str("1196178679394856772").unwrap();

        let input2 = vec![
            Fr::from(2347272),
            Fr::from(3512325),
            Fr::from(950157783),
            Fr::from(35),
            Fr::from(26357),
            Fr::from(354738949),
            Fr::from(30086),
            Fr::from(246849),
            Fr::from(56943),
        ];
        let digest2 = Fr::from_str("427148781026573526").unwrap();

        let input3: Vec<_> = (0..100).into_iter().map(|i| Fr::from(i)).collect();
        let digest3 = Fr::from_str("1195679749296675902").unwrap();

        test_poseidon_against_vectors(
            &params,
            &vec![
                input0.as_slice(),
                input1.as_slice(),
                input2.as_slice(),
                input3.as_slice(),
            ],
            &vec![digest0, digest1, digest2, digest3],
        )
    }
}
