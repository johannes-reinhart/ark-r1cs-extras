use crate::poseidon_parameters::{convert_str_vec_to_fields, PoseidonConfigError};
use ark_crypto_primitives::sponge::poseidon::PoseidonConfig;
use ark_ed97::Fr;
use ark_ff::PrimeField;
#[cfg(not(feature = "std"))]
use ark_std::vec;

pub fn poseidon_parameters<F: PrimeField>() -> Result<PoseidonConfig<F>, PoseidonConfigError> {
    let rate = 4;
    let capacity = 1;
    let full_rounds = 8;
    let partial_rounds = 10;
    let alpha = 13;
    let t = rate + capacity;
    let ark = vec![
        "4152423402214112816951130127",
        "91767556159009785836796554036",
        "793845174903423183570040824",
        "49196576257203993566925348988",
        "56897658048543081283111405686",
        "41628671111467702767776110376",
        "36565581651847342804700955097",
        "59776430303579191353677519012",
        "111017377731134772844292526256",
        "14795060084629246500828357349",
        "57492974461763534939044602348",
        "48005996272402938251695518407",
        "82038642496740103230979463225",
        "62764269523547684123845027300",
        "69723419528014157678639562689",
        "77180173477772311792100780394",
        "29626137363282611147809622901",
        "16985051792649709755843267600",
        "19120081214346121066914590131",
        "128281617061117801641463713373",
        "79028016795281145017664210422",
        "84511647472834825795243347685",
        "44253253791501773138097982911",
        "88919139125997706538433990734",
        "76541463990321176456443333515",
        "131226376883045571143606734696",
        "90427184844301880268006619581",
        "71328859451896859329333243242",
        "121691392215668715598943455535",
        "38979281860035479776457801417",
        "96242240212348493551582555597",
        "78563888954518816372139826129",
        "739671186726031874696682455",
        "30023744988306319363847604620",
        "75539860581402270753877754488",
        "47944990298397311236081024924",
        "76196288797401124016875204360",
        "44335533854742061656212768473",
        "409312148046397848907189093",
        "19055163538103288209581097495",
        "56293342315002298675903130838",
        "59064050608680062002002866415",
        "25778622507355879847731999733",
        "85345133190382196338609141905",
        "36751302304458356873604711713",
        "88246889469524357403937332310",
        "15853432648017270302039902442",
        "134500429356954176431956260617",
        "82521503797512646261675146611",
        "46093783431792589267886921713",
        "17535836126128134727268315121",
        "97105529863648759611948825374",
        "106902470125303262533432036480",
        "102059070615216262118391358765",
        "44251452694075446307184125859",
        "126466534785310689930004811369",
        "109853350540076075749690065074",
        "75663599153555462124859746761",
        "2803512335014977268764122473",
        "50473497757816242660460470499",
        "107279943465767083224327770708",
        "62754240409057864432057291589",
        "71123833335974620783165825406",
        "115608613494506401877160335907",
        "111400524035300009641124668374",
        "87512027084721111078379946073",
        "44244422098613683917797680712",
        "73514509864373300371992828622",
        "66243148208618776404344242065",
        "136987853940349856565442267269",
        "12936850963261390514419640426",
        "5552741776366127514037244455",
        "67060724298272965099661509850",
        "104175407776712486046710059878",
        "11855403551245235271868891770",
        "51610349076715993185092748602",
        "114288252587973077837493174691",
        "5135212121716902845386968531",
        "7911390861694902843511316984",
        "99299338057232250752277943297",
        "26903110811670097038132533377",
        "79690912606215302627570298524",
        "34001731604446072542191976893",
        "104708381470332887886196242587",
        "98755908879520143126570690427",
        "106508455050588884261461960108",
        "12233077732177597709887232184",
        "138473754115948989013672389033",
        "51696194672427660797142017030",
        "60749252116616488989856259449",
    ];
    let mds = vec![
        "78469846046687746048004746938",
        "80620710367351768552488947544",
        "104330660471979591818646222288",
        "55928605289981153137959536477",
        "70313877699095325539828341642",
        "98503949435282793547965804905",
        "71022521862013679837235715904",
        "44739826477742509222037847295",
        "124009271936202728886665358623",
        "69566092527755537958481593954",
        "25287916189370587931498187137",
        "127750622302241660995084210308",
        "123053247112059241811593819329",
        "77810537131043583641241301035",
        "41765652209899201480941275996",
        "77084006862444909205659053960",
        "53935142567518975976344771539",
        "30262548044016310090111094734",
        "45085736139390266897088854921",
        "42229362014733094919736815325",
        "117140276169917638849606025953",
        "57249889363904949115876713736",
        "39316608574205005369322876139",
        "140771304788653745911986330434",
        "61948794173615935243659673157",
    ];

    assert_eq!(ark.len(), (full_rounds + partial_rounds) * t);
    assert_eq!(mds.len(), t * t);

    let ark = convert_str_vec_to_fields::<F>(t, &ark)
        .map_err(|_| PoseidonConfigError::ConversionError)?;
    let mds = convert_str_vec_to_fields::<F>(t, &mds)
        .map_err(|_| PoseidonConfigError::ConversionError)?;

    Ok(PoseidonConfig {
        full_rounds,
        partial_rounds,
        alpha,
        ark,
        mds,
        rate,
        capacity,
    })
}

pub fn poseidon_parameters_ed97() -> PoseidonConfig<Fr> {
    poseidon_parameters::<Fr>().unwrap_or_else(|_| panic!("could not convert parameters"))
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::poseidon_parameters::tests::test_poseidon_against_vectors;
    use ark_ed97::Fr;
    use std::str::FromStr;

    #[test]
    fn test_poseidon() {
        let params = poseidon_parameters_ed97();

        let input0 = vec![Fr::from(0)];
        let digest0 = Fr::from_str("62368287993004475853405278667").unwrap();

        let input1 = vec![Fr::from(1), Fr::from(2), Fr::from(42)];
        let digest1 = Fr::from_str("125023950177289844308794464947").unwrap();

        let input2 = vec![
            Fr::from(2347272),
            Fr::from(3512325),
            Fr::from(950157783),
            Fr::from(35),
            Fr::from(26357),
            Fr::from(354738949),
            Fr::from(30086),
            Fr::from(246849),
            Fr::from(56943),
        ];
        let digest2 = Fr::from_str("17015892077045853759514857361").unwrap();

        let input3: Vec<_> = (0..100).into_iter().map(|i| Fr::from(i)).collect();
        let digest3 = Fr::from_str("123961300630351834104928859286").unwrap();

        test_poseidon_against_vectors(
            &params,
            &vec![
                input0.as_slice(),
                input1.as_slice(),
                input2.as_slice(),
                input3.as_slice(),
            ],
            &vec![digest0, digest1, digest2, digest3],
        )
    }
}
