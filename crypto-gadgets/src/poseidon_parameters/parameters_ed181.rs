use crate::poseidon_parameters::{convert_str_vec_to_fields, PoseidonConfigError};
use ark_crypto_primitives::sponge::poseidon::PoseidonConfig;
use ark_ed181::Fr;
use ark_ff::PrimeField;
#[cfg(not(feature = "std"))]
use ark_std::vec;

pub fn poseidon_parameters<F: PrimeField>() -> Result<PoseidonConfig<F>, PoseidonConfigError> {
    let rate = 4;
    let capacity = 1;
    let full_rounds = 8;
    let partial_rounds = 25;
    let alpha = 11;
    let t = rate + capacity;
    let ark = vec![
        "125232862974417824295006640774447803855490471468004991",
        "152160562955732727417643690936235665148326491082420268",
        "983993159662573068080553700047973167809804927181988383",
        "16371542905160450437135655012253803889814829746884768",
        "875915483530098523723052264707651187704298483554634776",
        "983433150300909271891794824176271337509854800140352233",
        "1449794909370881728134665357112828963470426967160266837",
        "339277979737566929015169250623658531753202464084532432",
        "125385266011350986291448609897767858205861485117903168",
        "1247505183853190899015344015584775275845922969332670564",
        "872567324806137317064833487271926201609891022317488414",
        "142251880238193886881165768292673568572835091661849087",
        "1522778716060084514841179054132835363197859646661562056",
        "537451140372070088481856943215014561699275405922617048",
        "1382962595361740687014550187400938357207605784031433010",
        "1541224114846075623890568544284033233075202068832291433",
        "1384660796390659638442528989801305997596169929485877869",
        "1406029609522006257655367077392345883200310302112385938",
        "1112186341393531468209189256644274939840996835525901330",
        "862158040325665740125172717815163247476556712937606186",
        "1297449419927282602617977842805042586852652679675117652",
        "763970319113184618334499646971540160804641727255628703",
        "82651558326683100028736987991346331911331891597415847",
        "374301405539001978908956067165158721101388863316318326",
        "810580644335380892914518254578878942975885906843971255",
        "776335907842777855470361893168251414610812898984035715",
        "1387093834550914076530556391824097181399983698420901502",
        "1088430235793610540068878292093212244646857560370998961",
        "1362981794680831570302343988066335242061386877768152901",
        "1008457512343302851161533979333268858010360997458798347",
        "1095000117044056864385682801900951709624094422262283424",
        "753797044070226131905134461613511128090541028810918034",
        "1317896746285031241487355914225064111244622321157592950",
        "1369120199400665814968657268948566535898493707382702515",
        "4017116652239527657241707852539829474249421971057537",
        "394209914228771017193297625859653561736211454666625636",
        "563724745405423970177713411972861163604876932899578300",
        "674653389892716762770958303728475250052895864025174284",
        "1366578253163355859207676729726385249690402929484203741",
        "678520362355342946099024148272146590098219125712392081",
        "644650563166155058697290449793925322467337846100215588",
        "887758197670071699985558916627760311082394962257642876",
        "1139341628431041969017193011011823818393581049539821476",
        "977093246716178941028603972435166046539091787981532688",
        "203909808533031150580232767196714488190718221462822846",
        "1115023219162957702086401828675098660564324489840807853",
        "229955695907781628067271113888978874184466661357408523",
        "43105449170152698246053184082829612444421628953383488",
        "310792130780775408260348365435860783850676394084329342",
        "779602442531167647853007332526178313397422147295640961",
        "698546878742878795478638624093117441401076462478298865",
        "1360437813841918385131537008855361714473542386539840279",
        "480750699069841145551827891715044089455170247053783760",
        "308442993920640475116377867481867194020245758969489221",
        "1091277727786338903946668461109510622800465343808455145",
        "775751821263372467063018024608123046937511352433740714",
        "69580023692549440736215808687932327264227349940418446",
        "1486662821967501410781566869074574791092738434917762699",
        "1121687818640634993686848666007379094335291447436374174",
        "1521126865025988515097564617272691926505220978473589820",
        "810247813170895015125314811120030135010255751331566420",
        "314167655565291500950396891069141459271328416479481752",
        "636206266241952247474046835688964507178754749166543749",
        "1321576236955465123526838594559286771216435300886415284",
        "675352323310193990563639055296214340715619705984241914",
        "1025373720147785725987400552975762395240427797029443161",
        "710782566553640646756580093379606985125091153361706525",
        "513608870886123774637477944492670945292474212052574797",
        "700259802200488829027222769224150100662378172256839309",
        "1191878240261726512911449098453003440764049818542148784",
        "691923884859761735696342906647333738450597363697806122",
        "823777618891951260278025751992533870374539486533921263",
        "690744106267871218908038957174693596342110550230772642",
        "360409170426736931496497554204985052462301529645176798",
        "632148666767995217619515944999766512800807264983092694",
        "603135023748697716886025404584624633297150780849219246",
        "428035908075413474464542888479162343475493906951688595",
        "1093823363885074699909263600141514772313197947705128807",
        "1434267858879034173536969711021365663791486042156177966",
        "1267674516283649180491917642734787272523399852331215324",
        "194613766626970885055200278960614125005821603042279208",
        "409314775177996969311759244536569741081310636706684136",
        "1357341259910763885599083867943483969454990527221754807",
        "1547536998495570873939356980745492318890332646921907204",
        "384771597058575536636610393767342984042113268413114998",
        "170071427077368287543203477329348413940529233489070652",
        "940630107093890871960718813488008206240833597363867174",
        "1468725458975843305534134196647999268969519037933501762",
        "894164555680736443783000420604838987627411899484502152",
        "27927077581098214909709623862157310721738913518465841",
        "1175203165638556086859601162303981676032138337451621737",
        "354915171985401701713691279695889001416821880206614288",
        "1144528284545653878637860359573817896044329472561265075",
        "52205635601551619501943963223603885211470985578633232",
        "1409103203263121788038749610254889208696489830624981213",
        "335186731248613258619127303595761190760195362140428728",
        "1138208475721797394147751852440275091544430441127619306",
        "398535219786226028689220659642374196845980402754466020",
        "626714789176185064664830157478726211304197330095916805",
        "325044840487718653814503629819042036012762014455874278",
        "897285268735754751187347770593861135494269389789855173",
        "1380620515855688214544021079783742977332353651173460187",
        "1089297120424339423575570328154899925132669675366652923",
        "211592932747307605394437333209561319031533364956483116",
        "315051936209604458314670927346137800809767587155223706",
        "1088769973644872754132923557694482582252226846937497144",
        "748771938533113535748565466231274003142616639907453058",
        "1149402669339498462924792437138393373112965177576240849",
        "1248425041816697235648407411974985374143950406179760206",
        "462287931354429902792909268532687174971729524783675077",
        "624148011598547612927073945042846373611608016513526725",
        "1291658209376657100636350898995521633184235770846366959",
        "1519994650521427361793274023627641754707380015156122631",
        "1328181651987734829853628050523541689276929440969848671",
        "1117976551155862347880441006949193629208767900342890086",
        "899250717046373627854975845837501484898167290780896267",
        "1036874547605151111115938842694558394695361582163768431",
        "1289304832704468338158686703635765458811089366702188167",
        "695410520431827440860698261146505413787245068325039511",
        "1031259320405245544037399757257262757105985942740715933",
        "74482045647602153665461791720095041741200757774754574",
        "1434743487722443316335010363960627155040112489449066047",
        "721696599173558881027940018315345410488116973061626041",
        "762473871797723514610331964054533423537426563227021339",
        "720399723255393814580647930744292291346008677707741941",
        "327210346288516994100955357651964683532335384986731657",
        "1313869735002528960470875238121210596744469043991681812",
        "935049694683712296709269231122262030968325999982672934",
        "1318995924863971592849638870949576595956583291608063321",
        "180072402882443206988271503426153070128411328642456758",
        "920298307103256879759861621224524346950677677092819448",
        "1027133578019603942975866458154767116443207955230739805",
        "43322969524703720664315669546221918505034039780576478",
        "892643639994751323058006211534949383298895282634806381",
        "812768534265611430537853531455681389732769950342296876",
        "1327771594599905102581556780463190193170235888449436181",
        "331720960418393297430920627666646403067157975202400659",
        "721647167735069082997434232637727328452743936888085183",
        "1400500006054692124351494434101813210570255587801856995",
        "996211056760863287414958163073294293275447530576068455",
        "1032365312416492773684247856539386412117628241258848040",
        "516847295576120694770586904704594377608856514010990273",
        "121153750018790414121919126810315141219484939215682080",
        "171463947013777896324692451659846547247971034488061963",
        "723518270217120976420686536181371970938396015003864904",
        "4126121775136766153299058606756398851855398313985745",
        "240548812489525091593366902130484235645624350801136334",
        "623884385601508309842969612936705284485276560507036433",
        "1253358242107297350453280921226892023775319621883470585",
        "824671823884103247486911371774633237345125380879970149",
        "128943160980409441272790404453617806108742961293279945",
        "976852793242214746659628064605830643734491514874894119",
        "606584709920306533118411800870614618468807354971712005",
        "366289530236937821142321908656358856253994876889479279",
        "479218525450343070937420011713543349859002201000688599",
        "699226773562566246127586353198852532918454816648213477",
        "1254061097892275174599216735503998436349958585867806607",
        "747894938235195807766260143820645032398861282639994453",
        "348085749732505623621137813120902029118310866542894950",
        "1361612662552162344785225269208613406356294018628335562",
        "786229199338723253676289776038424947809063914890401953",
        "432990777028292350351065350942161400780603791310785628",
        "629888517780440491994462733388858297183070670895431256",
        "511878926233873050195123375639659478094457836534201177",
        "1478618949072736041311389363764885840610997411157485878",
    ];
    let mds = vec![
        "435125283321141275807236538486434954684634440943141060",
        "433501908721085233732423620868513378954710771926031657",
        "1478915178711280965061204106626764495494755997045109026",
        "564971032269125347420133003027819765753676757030141727",
        "1353902290167172945043302367248701167316989997067753782",
        "671982752328609554693459627863705039011114526256284233",
        "686345115317010130433056060766495417316694625102539780",
        "396056963109241405960270385544890549148687227944056328",
        "106706104068038892765910030641732428659755728753843850",
        "828091835910572007451108874825625973341707065363664377",
        "1195716457171235078878752349554949270934170086379252125",
        "614200764538309945778499874703768669205887107697683981",
        "408889547592393328739452771650790488425501976597675022",
        "342124950174511756592227762327602476464043939860005587",
        "442204677587931769218758732258426271487420727546857499",
        "231803740763080426243998009697971750223540037073098429",
        "473280017229203169952907191645428361865883920232958565",
        "503708226195456369029170340225425083451217648680741013",
        "703880644160322382455783174810560077616877391874679367",
        "778434026672341436988516847872250255292647642288205005",
        "642754534095412862926743910172501142774777189638842472",
        "24125083670024511232022277376580658810395258004110540",
        "222102691568588518130860584656147683714739443778635330",
        "932455513559783162070665755484953882718476541187122497",
        "260516022726713646692337945113171003062488612127389419",
    ];

    assert_eq!(ark.len(), (full_rounds + partial_rounds) * t);
    assert_eq!(mds.len(), t * t);

    let ark = convert_str_vec_to_fields::<F>(t, &ark)
        .map_err(|_| PoseidonConfigError::ConversionError)?;
    let mds = convert_str_vec_to_fields::<F>(t, &mds)
        .map_err(|_| PoseidonConfigError::ConversionError)?;

    Ok(PoseidonConfig {
        full_rounds,
        partial_rounds,
        alpha,
        ark,
        mds,
        rate,
        capacity,
    })
}

pub fn poseidon_parameters_ed181() -> PoseidonConfig<Fr> {
    poseidon_parameters::<Fr>().unwrap_or_else(|_| panic!("could not convert parameters"))
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::poseidon_parameters::tests::test_poseidon_against_vectors;
    use ark_ed181::Fr;
    use std::str::FromStr;

    #[test]
    fn test_poseidon() {
        let params = poseidon_parameters_ed181();

        let input0 = vec![Fr::from(0)];
        let digest0 =
            Fr::from_str("1066156306611225710747255607056923266361119500752643239").unwrap();

        let input1 = vec![Fr::from(1), Fr::from(2), Fr::from(42)];
        let digest1 =
            Fr::from_str("254794443942546584463919601617358577756839666470706520").unwrap();

        let input2 = vec![
            Fr::from(2347272),
            Fr::from(3512325),
            Fr::from(950157783),
            Fr::from(35),
            Fr::from(26357),
            Fr::from(354738949),
            Fr::from(30086),
            Fr::from(246849),
            Fr::from(56943),
        ];
        let digest2 =
            Fr::from_str("227958055621725508562786906168031435865926835155031370").unwrap();

        let input3: Vec<_> = (0..100).into_iter().map(|i| Fr::from(i)).collect();
        let digest3 =
            Fr::from_str("1467768971804367025211255218594308441085612368489612972").unwrap();

        test_poseidon_against_vectors(
            &params,
            &vec![
                input0.as_slice(),
                input1.as_slice(),
                input2.as_slice(),
                input3.as_slice(),
            ],
            &vec![digest0, digest1, digest2, digest3],
        )
    }
}
